# CRU internal data generator
The internal data generator (DDG) generates a stream of data, continuous or formatted, to test the CRU data taking chain.

![Alt text](fig/ddg_block.png "design")


## Modes

### Continuous mode
In continuous mode a counter is sent as payload. If the tpc emulator bit is asserted, instead of the counter a TPC style stream is sent which consists of 8 header frame with pre-defined pattern, and then random data generated by a PRNG. The reset in this mode is 8-frame aligned meaning it is actually asserted only on the next 8-frame boundary.


### Packet mode

In packet mode the data is formatted according to the following data structure.

![Alt text](fig/gbt_data_struct1.png "New data format")

Each Heartbeat Frame (HBF) consists of multiple blocks of max 8kB size. At every HB trigger, the current HBF is closed, and a new one is started, with the new HB orbit in the RDH.

![Alt text](fig/gbt_data_struct2.png "HBF data format")

A HBF starts with a RDH (\"HBF open\"). This RDH is repeated every 8 kB, incrementing only the page counter each time. The payloads of different events fill up the 8 kB continuously. 

![Alt text](fig/gbt_data_struct3.png "GBT data format")

If the 8 kB limit is reached (512 GBT word, RDH included), a RDH is generated, and the remaining data goes to this next packet. At the next HB trigger an extra RDH-only packet (\"HBF close\") is sent with the STOP bit set.
By default internal trigger is used (the 'Use external trigger' bit is 0), which is always high, so packets are sent continuously without waiting for any triggers. If TTC is selected as trigger source, the actual bits that trigger a packet can be selected from TTC\_DATA[31:0] with a mask. 
Triggers that arrived during the sending of a packet are ignored (expect HB, for which the trailer and header for the next HBF are sent after the current packet). To start the DDG a SOx trigger, to stop the DDG, a EOx trigger must be sent, 


## Features

It is possible to generate packets with different features to stress the logic of the CRU. 

### Random mode

The module uses the same PRSG instance for generating random IDLE words and packet sizes (the PRSG module itself is defined in the cru\_misc library)
When random mode is selected 
 - the number of extra IDLE words can vary between 0 and 1023 (there's always 1 default IDLE between packets),
 - the packet size (with header, in words) can vary between 4 (only header) and 512

There are also configurable number of extra IDLEs (4 IDLEs by default) between every packets (min. 0, max 1023).

### Pause
The data generator can be paused. In this case it waits for the current packet to be sent and then stops (Reset does not wait for the EOP)


## Register description
There are two registers, one for control and configuration, one for statistics.

| Register address | Description         |
| ---------------- | ------------------- |
| 0x0D00\_0000      | Control register    |
| 0x0D00\_0004      | Control register \#2   |
| 0x0D00\_0008      | Control register \#3   |
| 0x0D00\_000C      | Trigger mask |
| 0x0D00\_0010      | Statistics register |



| Control register bits | Description                                                  |
| --------------------- | :----------------------------------------------------------- |
| 0                     | 0: send continuous stream of data<br /> 1: send formatted packets (SAP - Standard ALICE packets) |
| 1                     | Generate packets with random size                                  |
| 2                     | Random number of IDLE words between packets                        |
| 3                     | Random number of IDLE words in the packets                         |
| 4                     | Use external trigger                                         |
| 5                     | Select external trigger source<br /> 0: GBT Rx<br /> 1: TTC  |
| 8			| Pause	 	  	  	       	      	       	       |
| 16			| Enable TPC data format (8-frame predefined header, then payload)
| 31                    | Reset                                                        |

| Control register \#2 bits | Description                                                  |
| --------------------- | :----------------------------------------------------------- |
| 9..0                  | Sets number of extra IDLEs between packets if it's not random, default is 4 (min. 0, max. 1023) |
| 24..16		| Sets the max size of payload in gbt words. (min. 0, max. 508) |


| Control register \#3 bits | Description                                                  |
| --------------------- | :----------------------------------------------------------- |
| 8..0                  | Sets range for random sized packets. Min. 1, max. payload size-1, AND must be a power of 2. Resulting payload size range in gbt words: [max. payloadsize - range, max. payload size]|


| Trigger mask bits | Description                                                  |
| --------------------- | :----------------------------------------------------------- |
| 31..0                  | 32-bit mask to select which TTC\_DATA bits can trigger packets  |


| Statistics register bits | Description                             |
| ------------------------ | --------------------------------------- |
| 31..0                    | Number of sent packets since last reset |
